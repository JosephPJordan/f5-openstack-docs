<!DOCTYPE html>
<html>
 <head>

<link rel="icon" sizes="196x196" href="http://cdn.f5.com/digital-platforms/images/f5-196.png">

 <title>How to Deploy the F5 LBaaS Agent in OpenStack</title>    

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Site metadata -->
<meta name="description" content="Uniquely cloud-ready">

<!--styles-->
 <link rel="stylesheet" href="http://F5Networks.github.io/f5-openstack-docs/css/bootstrap-docs.css" type="text/css">

 <link rel="stylesheet" href="http://F5Networks.github.io/f5-openstack-docs/css/bootstrap.css" type="text/css">
    
 <link rel="stylesheet" href="http://F5Networks.github.io/f5-openstack-docs/css/bootstrap-theme.css" type="text/css">

 <link rel="stylesheet" href="http://F5Networks.github.io/f5-openstack-docs/css/font-awesome.css" type="text/css">
 
<!-- tocify styles-->
 <link type="text/css" rel="stylesheet" href="http://F5Networks.github.io/f5-openstack-docs/css/jquery.tocify.css">

<!-- jekyll stuff
 <link rel="canonical" href="http://F5Networks.github.io/f5-openstack-docs/m_install_lbaas_plugin_agent/">-->

 <link rel="alternate" type="application/rss+xml" title="F5 OpenStack" href="http://F5Networks.github.io/f5-openstack-docsfeed.xml" />
   
</head>



<body>
  <header>
  <nav class="navbar navbar-default navbar-fixed-top">
    <div class="container-fluid">
      <!-- Brand and toggle get grouped for better mobile display -->
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#topFixedNavbar1" aria-expanded="false"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button>
        <a class="navbar-brand" href="http://f5.com"><img src="https://cdn.f5.com/digital-platforms/images/logo.svg" alt="F5 Networks" height="25"></a> </div>
      <!-- Collect the nav links, forms, and other content for toggling -->
      <div class="collapse navbar-collapse" id="topFixedNavbar1">
        <ul class="nav navbar-nav">
          <li class="active"><a href="http://github.com/F5Networks">F5Networks on GitHub<span class="sr-only">(current)</span></a></li>
          <li><a href="http://devcentral.f5.com">DevCentral</a></li>
          <li><a href="http://support.f5.com">Support</a></li>
          <li><a href="https://devcentral.f5.com/d/openstack-neutron-lbaas-driver-and-agent">Get the LBaaSv1 Plugin</a></li>
          <li class="dropdown"><a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Project Repos<span class="caret"></span></a>
            <ul class="dropdown-menu">
              <!--li><a href="https://github.com/F5Networks/f5-openstack-lbaasv2">F5 OpenStack LBaaSv2 Plug-in</a></li-->
              <li role="separator" class="divider"></li>
              <!--li><a href="#">F5 OpenStack API Libraries</a></li-->
              <li><a href="https://github.com/F5Networks/openstack-f5-lbaasv1">F5 OpenStack LBaaSv1 plugin driver</a></li>
              <li><a href="https://github.com/F5Networks/f5-openstack-agent">F5 OpenStack LBaaSv1 plugin agent</a></li>
               <li role="separator" class="divider"></li>
              <li><a href="https://github.com/F5Networks/f5-common-python">F5 common python</a></li>
              <li><a href="https://github.com/F5Networks/f5-openstack-odk">F5 OpenStack Deployment Kit</a></li>
              <li><a href="https://github.com/F5Networks/f5-openstack-heat-plugins">F5 OpenStack Heat Plug-ins</a></li>
            </ul>
          </li>
        </ul>
        <form class="navbar-form navbar-right" role="search">
          <div class="form-group">
            <input type="text" class="form-control" placeholder="Search">
          </div>
          <button type="submit" class="btn btn-default">Submit</button>
        </form>
        <ul class="nav navbar-nav navbar-right">
          <li class="dropdown"><a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Partners<span class="caret"></span></a>
            <ul class="dropdown-menu">
              <li><a href="#">Mirantis</a></li>
              <!--li><a href="#">Another action</a></li-->
              <!--li><a href="#">Something else here</a></li-->
              <li role="separator" class="divider"></li>
              <!--li><a href="#">Separated link</a></li-->
            </ul>
          </li>
        </ul>
      </div>
      <!-- /.navbar-collapse -->
    </div>
    <!-- /.container-fluid -->
  </nav>
</header>
 <hr>  
     <div class="bs-docs-header">
    <h1>How to Deploy the F5 LBaaS Agent in OpenStack</h1>
   </div>
  </div>

  <div class="bs-docs-sidebar">
    <div class="bs-docs-sidenav" id="toc">
    </div>
  </div>
 <div class="bs-docs-container">
  	
		 <p>#How to Deploy the F5 LBaaS Agent in OpenStack</p>

<h2 id="overview">Overview</h2>

<p>This guide will help you set up load-balancing as a service (LBaaS) in OpenStack using the F5 OpenStack LBaaSv1 Plugin. Deploying the F5 LBaaS Plugin in an OpenStack environment allows you to provision virtual IPs, server pools, health monitors, and load balancing on your BIG-IP hardware or Virtual Edition.</p>

<h3 id="prerequisites">Prerequisites</h3>

<ul>
  <li>
    <p>Download the F5 OpenStack Plug-in package from <a href="https://devcentral.f5.com/d/openstack-neutron-lbaas-driver-and-agent">F5’s DevCentral</a>.</p>
  </li>
  <li>
    <p>Install the <a href="http://F5Networks.github.io">F5 LBaaS Plug-in Driver</a> before you deploy the Agent.</p>
  </li>
  <li>
    <p>Set up at least one BIG-IP cluster - or, ‘device service group (DSG)’ -  before you deploy the Agent. You’ll need administrator access to the BIG-IP and all cluster members to do so.</p>
  </li>
</ul>

<p><strong>Tip:</strong> Make note of the IP addresses and credentials for the devices in the cluster; you’ll need to enter them in the Agent config file(s).</p>

<ul>
  <li>Agent config file(s) (<a href="f5-os-agent/os_lbaas_agent_config_settings.xlsx">see Table 1</a>). The installation will create a default config file, but you’ll need to manually create a separate file for each Agent you deploy.</li>
</ul>

<h3 id="placement">Placement</h3>

<p>The F5 LBaaS Agent can run on any host that has the Neutron python libraries installed. We recommend using a Neutron Controller or Gateway node, as they contain the appropriate libraries by default. You can also run the agent on a dedicated node.</p>

<p>We also recommend running multiple F5 LBaaS agents for the same environment simultaneously on different hosts. Doing so provides some redundancy in LBaaS provisioning for that environment.</p>

<p><strong>Note:</strong> If you choose to deploy multiple agents for the same environment, they <em>must</em> run on different hosts.</p>

<p>You can run multiple F5 LBaaS agents simultaneously on the same host, but they must be orchestrating different environments (in other words, different TMOS clusters with unique environment prefixes).</p>

<h2 id="install-the-f5-openstack-lbaas-plug-in-agent">Install the F5 OpenStack LBaaS Plug-in Agent</h2>

<p>Use the command set for your distribution to install the Neutron Gateway Packages for the F5 LBaaS Agent.</p>

<h3 id="ubuntu">Ubuntu:</h3>

<p><code>dpkg -i f5-bigip-lbaas-agent_1.1.0-1_all.deb</code></p>

<h3 id="red-hatcentos">Red Hat/CentOS:</h3>

<p><code>rpm -i f5-bigip-lbaas-agent-1.1.0-1.noarch.rpm</code></p>

<p><strong>NOTE:</strong> The actual file names will vary from version to version.</p>

<h2 id="stop-the-agent">Stop the Agent</h2>

<p>The agent launches automatically on install. Since it hasn’t been configured yet, <strong>run the below command to stop the process</strong>:</p>

<p><code>service f5-bigip-lbaas-agent stop</code></p>

<h2 id="installing-additional-agents">Installing Additional Agents</h2>

<p>Complete both of the installation steps (install, then stop) on each host on which you want the F5 LBaaS Agent to run.</p>

<h2 id="set-up-the-agent">Set up the Agent</h2>

<p>The agent configuration settings are found in <em>/etc/neutron/f5-bigip-lbaas-agent.ini</em>. (Figure 1) is a sample config file which shows the available options.</p>

<p>Table 1.</p>
<table width="797">
<tbody>
<tr>
<td colspan="2" width="797">F5 OpenStack LBaaS Agent Configuration Options</td>
</tr>
<tr>
<td width="341">[DEFAULT]</td>
<td width="456">&nbsp;</td>
</tr>
<tr>
<td width="341">debug = True</td>
<td width="456">Show debugging output in log (sets DEBUG log level output).</td>
</tr>
<tr>
<td width="341">periodic_interval = 10</td>
<td width="456">The LBaaS agent will resync its state with Neutron to recover from any transient notification or rpc errors. The periodic interval is number of seconds between attempts.</td>
</tr>
<tr>
<td width="341">service_resync_interval = 500</td>
<td width="456">How often the agent throws away its service cache and resyncs assigned services with the neutron LBaaS plugin.</td>
</tr>
<tr>
<td width="341">environment_prefix = uuid</td>
<td width="456">The environmental prefix that the agent applies to BIG-IP objects it creates. The default setting is 'uuid'.</td>
</tr>
<tr>
<td colspan="2" width="797">WARNING: You should set the environmental prefix before creating any BIG-IP objects. If you change it after you've created objects, those objects will no longer be associated with the agent and will have to be managed manually.</td>
</tr>
<tr>
<td width="341">static_agent_configuration_data = name1:value1, name1:value2, name3:value3</td>
<td width="456">Static configuration data to send back to the plugin. A single entry, or a comma-separated list of name:value entries, which will be sent in the agent's configuration dictionary to Neutron. This can be used on the plugin side of Neutron to provide agent identification for custom pool-to-agent scheduling.</td>
</tr>
<tr>
<td width="341">Device Setting</td>
<td width="456">Device type for LBaaS</td>
</tr>
<tr>
<td width="341">f5_device_type = external</td>
<td width="456">external - external (hardware or VE)</td>
</tr>
<tr>
<td width="341">f5_device_type = guest_admin</td>
<td width="456">guest_admin - VE created under the admin tenant</td>
</tr>
<tr>
<td>f5_device_type = guest_tenant</td>
<td width="456">guest_tenant - VE created under the pool tenant</td>
</tr>
<tr>
<td width="341">HA model</td>
<td width="456">Set High Availability (HA) model</td>
</tr>
<tr>
<td width="341">f5_ha_type = standalone</td>
<td width="456">Single device, no HA</td>
</tr>
<tr>
<td width="341">f5_ha_type = pair</td>
<td width="456">Active/standby two-device HA</td>
</tr>
<tr>
<td width="341">f5_ha_type = scalen</td>
<td width="456">Active device cluster</td>
</tr>
<tr>
<td colspan="2" width="797">Note: If the device is external, the devices must be onboarded for the appropriate HA mode or else the driver will not provision devices.</td>
</tr>
<tr>
<td width="341">Sync mode</td>
<td width="456">Set policy sharing across devices</td>
</tr>
<tr>
<td width="341">f5_sync_mode = autosync</td>
<td width="456">Syncable policies configured on one device are synced to the group.</td>
</tr>
<tr>
<td width="341">f5_sync_mode = replication</td>
<td width="456">Each device is configured separately.</td>
</tr>
<tr>
<td width="341">L2 Segmentation Mode Settings</td>
<td width="456">Configure L2 segmentation for pools or VIPs created on VLAN networks</td>
</tr>
<tr>
<td rowspan="4" width="341">Device VLAN to interface and tag mapping</td>
<td width="456">A comma-separated list of strings that specifiy to which interface the agent should map a VLAN and state if VLAN tagging should be enforced by the external device. The string should use the following format: "physical_network:interface_name:tagged".</td>
</tr>
<tr>
<td width="456">'"physical_network" corresponds to "provider:physical_network" attributes</td>
</tr>
<tr>
<td width="456">"interface_name" is the name of an interface or LAG trunk</td>
</tr>
<tr>
<td width="456">"tagged" is a boolean (True or False)</td>
</tr>
<tr>
<td width="341">standalone:</td>
<td width="456">&nbsp;</td>
</tr>
<tr>
<td width="341">f5_external_physical_mappings = default:1.1:True</td>
<td width="456">Maps the 'default' physical network to interface '1.1' with tagging enforced.</td>
</tr>
<tr>
<td width="341">pair or scalen:</td>
<td width="456">&nbsp;</td>
</tr>
<tr>
<td width="341">f5_external_physical_mappings = default:1.3:True</td>
<td width="456">Maps the 'default' physical network to interface '1.3' with tagging enforced.</td>
</tr>
<tr>
<td colspan="2" width="797">Note: If a network does not have a provider:physical_network attribute, or the provider:physical_network attribute does not match in the configured list, the 'default' physical_network setting is applied. At a minimum, you must have a 'default' physical_network setting. The '1.1' and '1.2' interfaces are used for HA purposes.</td>
</tr>
<tr>
<td width="341">Device Tunneling (VTEP) self-ips</td>
<td width="456">A single entry or a comma-separated list of cidr (h/m) format self-ip addresses - one per BIG-IP device - to use for VTEP addresses.</td>
</tr>
<tr>
<td width="341">f5_vtep_folder = 'Common'</td>
<td width="456">Sets the VTEP to use the default partition ("Common") on the BIG-IP.</td>
</tr>
<tr>
<td width="341">f5_vtep_selfip_name = 'vtep'</td>
<td width="456">Sets the VTEP self-ip name to "vtep".</td>
</tr>
<tr>
<td width="341">Tunnel types</td>
<td width="456">A comma-separated list of tunnel types to report as available from this agent and to send to compute nodes via tunnel_sync rpc messages. This should match the ml2 network types on your compute nodes.</td>
</tr>
<tr>
<td width="341">advertised_tunnel_types = gre</td>
<td width="456">use only gre tunnels</td>
</tr>
<tr>
<td width="341">advertised_tunnel_types = vxlan</td>
<td width="456">use only vxlan tunnels</td>
</tr>
<tr>
<td width="341">advertised_tunnel_types = gre,vxlan</td>
<td width="456">use gre and vxlan tunnel networks</td>
</tr>
<tr>
<td width="341">advertised_tunnel_types = vlan</td>
<td width="456">use only vlans</td>
</tr>
<tr>
<td colspan="2" width="797">Note: If no gre or vxlan tunneling is required, these settings should be commented out or set to None.</td>
</tr>
<tr>
<td width="341">Static ARP population for members on tunnel networks</td>
<td width="456">Creating a static ARP entry allows the agent to avoid having to learn Pool Members' MAC addresses via flooding. Use a boolean "True" or "False" entry to specify whether an entry should be created if a Pool Member IP address is associated with a gre or vxlan tunnel network and a tunnel fdb record is added.</td>
</tr>
<tr>
<td width="341">f5_populate_static_arp = True</td>
<td width="456">Sets the agent to create a static arp entry.</td>
</tr>
<tr>
<td width="341">Device Tunneling (VTEP) selfips</td>
<td width="456">A boolean "True" or "False" entry which determines if the BIG-IP will use L2 Population service to update its fdb tunnel entries.</td>
</tr>
<tr>
<td width="341">l2_population = True</td>
<td width="456">Tells the agent to configure the BIG-IP to use L2 Population service to update fbd tunnel entries.</td>
</tr>
<tr>
<td colspan="2">Note: This needs to be set up in parallel with the tunnel agents. If the BIG-IP and tunnel agent settings don't match, the tunnel setup will not work properly.</td>
</tr>
</tbody>
</table>

<h2 id="start-the-agent">Start the Agent</h2>

<p><strong>NOTE:</strong> If you want to start with clean logs, you should remove the log file first: <br />
<code>rm /var/log/neutron/f5-bigip-lbaas-agent.log</code></p>

<p>To start the agent, run <br />
<code>service f5-bigip-lbaas-agent start</code></p>

<h2 id="check-the-agent-status">Check the Agent Status</h2>

<p>To check the Agent’s status, run <br />
<code>neutron agent-list</code></p>

<p>Figure 1. <br />
<img src="//f5-os-lbaasv1/media/lbaas-agent-status.png" /></p>

<p><strong>NOTE:</strong> It may take a few seconds for the agent to appear in the status list (shown in Figure 1) after restarting. If the agent does not start properly, an error will be logged in <em>/var/log/neutron/f5-bigip-lbaas-agent.log</em>.</p>

<h2 id="enable-lbaas-in-openstack-gui">Enable LBaaS in OpenStack GUI</h2>

<p>Go to the OpenStack cloud controller node.</p>

<p>In the ‘local_settings’ file, set  ‘enable_lb’  to “True”, as shown below.</p>

<p><code>OPENSTACK_NEUTRON_NETWORK = { 'enable_lb': True, ...}"</code></p>

<h2 id="restart-the-web-server-to-make-the-setting-take-effect">Restart the web server to make the setting take effect:</h2>

<h3 id="ubuntu-1">Ubuntu</h3>
<p>To restart the web server, run<br />
<code>service apache2 restart</code></p>

<h3 id="red-hat--centos">Red Hat / CentOS</h3>
<p>To restart the web server, run<br />
<code>service httpd restart</code></p>

<h2 id="additional-information">Additional Information</h2>

<h3 id="tenant-scheduler">Tenant Scheduler</h3>
<p>The F5 LBaaS Plug-in uses a scheduler which, by default, associates all LBaaS pools on the same cluster with the same tenant. This association is maintained in the OpenStack database. To view the associations:</p>

<ol>
  <li>Run <code>neutron agent-list</code>.</li>
  <li>Run <code>neutron lb-pool-list-on-agent &lt;agent-id&gt;</code> for each LBaaS agent.</li>
</ol>

<p>If you add more agent-cluster groups, the LBaaS plug-in will automatically identify which agent it should talk to in order to service a given tenant.</p>

<p><strong>NOTE:</strong> If you delete all pools for a tenant, the record of how to map the tenant pool to an agent is also deleted. In such cases, the BIG-IP may choose a new agent for that tenant.</p>


    
	</div>
 
<hr>
<footer>
  <div class="footer">
      <ul class="list-inline">
      <li class="fa fa-3x"><a href="http://github.com/F5Networks" target="_blank" title="GitHub" ><i class="fa-github-square"></i></a></li>
      <li class="fa fa-3x"><a href="http://twitter.com/f5networks" target="_blank" title="Twitter" ><i class="fa-twitter-square"></i></a></li>
      <li class="fa fa-3x"><a href="http://www.linkedin.com/companies/f5-networks" target="_blank" title="LinkedIn"><i class="fa-linkedin-square"></i></a></li>
      <li class="fa fa-3x"><a href="http://www.facebook.com/f5networksinc" target="_blank" title="Facebook"><i class="fa-facebook-square"></i></a></li>
      <li class="fa fa-3x"><a href="http://www.youtube.com/f5networksinc" target="_blank" title="YouTube"><i class="fa-youtube-square"></i></a></li>
    </ul>
  </div>
</footer>
</body>

<!-- tocify scripts-->
<script src="http://code.jquery.com/jquery-1.11.3.js"></script>
<script src="http://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
<script src="http://F5Networks.github.io/f5-openstack-docs/js/jquery.tocify.js"></script>
<script>
        $(function() {
            //Calls the tocify method on the HTML div.
            $("#toc").tocify();
        });
</script>    
</html>          

